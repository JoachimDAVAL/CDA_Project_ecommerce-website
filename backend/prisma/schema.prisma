generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum Role {
  USER
  ADMIN
  ARTIST
}

enum ModelStatus {
  PENDING
  ONLINE
  REJECTED
}

enum FileType {
  SOURCE_3D
  RENDER_IMAGE
}

enum PaymentStatus {
  PAID
  FAILED
  REFUNDED
}

// --- MODELS ---

model User {
  id               Int      @id @default(autoincrement())
  email            String   @unique
  password         String
  username         String
  registrationDate DateTime @default(now())

  // Tableau d'Enums natif (Postgres)
  roles Role[] @default([USER])

  firstName      String?
  lastName       String?
  profilePicture String? 
  
  defaultAddress String?
  country        String?

  artist  Artist?
  orders  Order[]
  reviews Review[]

  @@map("user")
}

model Artist {
  id              Int     @id @default(autoincrement())
  shopDescription String?
  
  siret           String  @unique @db.Char(14)
  
  portfolioLink   String?

  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  models Model3D[]

  @@map("artist")
}

model Model3D {
  id          Int         @id @default(autoincrement())
  title       String
  description String?     @db.Text
  price       Decimal     @db.Decimal(10, 2)
  createdAt   DateTime    @default(now())
  status      ModelStatus @default(PENDING)
  viewCount   Int         @default(0)

  artistId Int
  artist   Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  files      File[]
  reviews    Review[]
  orderItems OrderItem[]

  @@map("model_3d")
}

model File {
  id       Int      @id @default(autoincrement())
  cloudUrl String
  type     FileType
  format   String?
  sizeKb   Int?

  modelId Int
  model   Model3D @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@map("file")
}

model Order {
  id             Int           @id @default(autoincrement())
  orderDate      DateTime      @default(now())
  totalAmount    Decimal       @db.Decimal(10, 2)
  paymentStatus  PaymentStatus
  billingName    String
  billingAddress String
  billingCountry String
  appliedVat     Decimal       @db.Decimal(5, 2)

  customerId Int?
  customer   User? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  items OrderItem[]

  @@map("order")
}

model OrderItem {
  id            Int     @id @default(autoincrement())
  quantity      Int     @default(1)
  unitPricePaid Decimal @db.Decimal(10, 2)

  modelTitleSnapshot String? 

  orderId Int
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  modelId Int?
  model   Model3D? @relation(fields: [modelId], references: [id], onDelete: SetNull)

  @@map("order_item")
}

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int      @db.SmallInt
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  authorId Int
  author   User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  modelId Int
  model   Model3D @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([authorId, modelId])
  @@map("review")
}
